<script>
  // --- Configuração do Supabase ---
  const SUPABASE_URL = "https://wcgrcntyencwkwwnuwyz.supabase.co"; // ⬅️ Substitua
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjZ3JjbnR5ZW5jd2t3d251d3l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDM1NDksImV4cCI6MjA3ODQ3OTU0OX0.dKUY44Cc_D0I00h0ZbhCVmuIonqMlxcIPBhHUOK1YwM"; // ⬅️ Substitua
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- Dados do operador logado ---
  const operador = localStorage.getItem("operador_nome");
  if (!operador) {
    window.location.href = "index.html"; // Se não houver operador, volta para o login
  } else {
    document.getElementById("operador").textContent = `Operador: ${operador}`;
  }

  const maquinaSelect = document.getElementById("maquina");
  const pecaSelect = document.getElementById("peca");
  const contadorEl = document.getElementById("contador");
  const atualizadoEl = document.getElementById("atualizado");
  const dataHoraEl = document.getElementById("dataHora");

  let maquinaAtual = "";
  let pecaAtual = "";

  // --- Atualiza data/hora ---
  function atualizarDataHora() {
    const agora = new Date();
    dataHoraEl.textContent = `Data/Hora: ${agora.toLocaleString("pt-BR")}`;
  }
  setInterval(atualizarDataHora, 1000);
  atualizarDataHora();

  // --- Carrega máquinas e peças (ordenadas corretamente) ---
  async function carregarListas() {
    const { data: maquinas } = await supabase
      .from("maquinas")
      .select("id, nome")
      .order("id", { ascending: true });

    const { data: pecas } = await supabase
      .from("pecas")
      .select("id, nome")
      .order("id", { ascending: true });

    maquinas?.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.nome;
      maquinaSelect.appendChild(opt);
    });

    pecas?.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.nome;
      pecaSelect.appendChild(opt);
    });
  }
  carregarListas();

  // --- Atualiza contagem da produção em tempo real ---
  async function atualizarContagem() {
    if (!maquinaAtual || !pecaAtual) return;

    const { data, error } = await supabase
      .from("producao")
      .select("quantidade")
      .eq("operador", operador)
      .eq("maquina", maquinaAtual)
      .eq("peca", pecaAtual)
      .order("data_hora", { ascending: false })
      .limit(1);

    if (error) {
      console.error("Erro ao consultar produção:", error);
      return;
    }

    const qtd = data && data.length > 0 ? data[0].quantidade : 0;
    contadorEl.textContent = qtd;
    atualizadoEl.textContent = `Atualizado às ${new Date().toLocaleString("pt-BR")}`;
  }

  setInterval(atualizarContagem, 5000);

  // --- Selecionar máquina e peça ---
  maquinaSelect.addEventListener("change", () => {
    maquinaAtual = maquinaSelect.value;
    atualizarContagem();
  });

  pecaSelect.addEventListener("change", () => {
    pecaAtual = pecaSelect.value;
    atualizarContagem();
  });

  // --- Iniciar nova produção ---
  document.getElementById("novaProducao").addEventListener("click", () => {
    maquinaSelect.value = "";
    pecaSelect.value = "";
    maquinaAtual = "";
    pecaAtual = "";
    contadorEl.textContent = "0";
    atualizadoEl.textContent = "";
  });

  // --- Sair ---
  document.getElementById("sair").addEventListener("click", () => {
    localStorage.removeItem("operador_nome");
    window.location.href = "index.html";
  });
</script>
