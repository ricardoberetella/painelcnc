<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Produ√ß√£o - CNC</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--accent:#38bdf8;--muted:#94a3b8;--ok:#4ade80}
    body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--bg),#1e293b);color:#fff;margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center}
    header{width:100%;padding:16px 20px;background:rgba(255,255,255,0.03);box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;justify-content:space-between;align-items:center}
    header h1{color:var(--accent);margin:0;font-size:18px}
    .container{width:94%;max-width:980px;margin-top:28px;background:rgba(255,255,255,0.04);padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select,input{padding:8px;border-radius:6px;border:none;background:rgba(255,255,255,0.03);color:#fff;min-width:150px}
    .info{margin-top:12px;font-size:16px}
    .big {font-size:56px;font-weight:700;color:var(--ok);margin:12px 0}
    .small-muted{color:var(--muted);font-size:13px}
    button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#032;cursor:pointer}
    button.secondary{background:#f87171;color:#fff}
    table{width:100%;margin-top:14px;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px}
    th{color:var(--accent);font-weight:600}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <h1>üìä Painel de Produ√ß√£o - CNC</h1>
    <div id="headerRight" class="small-muted"></div>
  </header>

  <main class="container">
    <div class="topbar">
      <div>
        <div class="small-muted">Operador</div>
        <div id="operadorNome" style="font-weight:700;font-size:18px">‚Äî</div>
      </div>

      <div>
        <div class="small-muted">M√°quina</div>
        <select id="selectMaquina"><option value="">Carregando...</option></select>
      </div>

      <div>
        <div class="small-muted">Pe√ßa</div>
        <select id="selectPeca"><option value="">Carregando...</option></select>
      </div>

      <div>
        <div class="small-muted">Atualiza√ß√£o</div>
        <div id="atualizacao" class="small-muted">‚Äî</div>
      </div>

      <div>
        <button id="btnSalvar">Salvar sele√ß√£o</button>
        <button id="btnSair" class="secondary">Sair</button>
      </div>
    </div>

    <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.04);margin:14px 0">

    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="small-muted">√öltimo registro</div>
      <div id="ultimoRegistro" class="info">‚Äî</div>

      <div class="small-muted">Produ√ß√£o total (operador + m√°quina + pe√ßa)</div>
      <div id="contador" class="big">0</div>

      <div id="detalhes" class="small-muted">‚Äî</div>
    </div>

    <table id="ultimosRegistros" aria-label="√öltimos registros">
      <thead>
        <tr><th>Data/Hora</th><th>M√°quina</th><th>Pe√ßa</th><th>Quantidade</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function () {
    // ---------- CONFIGURE AQUI ----------
    const SUPABASE_URL = "https://wcgrcntyencwkwwnuwyz.supabase.co"; // substitua se necess√°rio
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjZ3JjbnR5ZW5jd2t3d251d3l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDM1NDksImV4cCI6MjA3ODQ3OTU0OX0.dKUY44Cc_D0I00h0ZbhCVmuIonqMlxcIPBhHUOK1YwM";
    const supabase = supabaseCreateClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function supabaseCreateClient(url, key) {
      try { return supabaseJs.createClient ? supabaseJs.createClient(url, key) : supabase.createClient(url, key); }
      catch(e){ return supabase.createClient(url, key); }
    }
    // ---------- /CONFIGURE AQUI ----------

    // Elementos
    const operadorNomeEl = document.getElementById("operadorNome");
    const selectMaquina = document.getElementById("selectMaquina");
    const selectPeca = document.getElementById("selectPeca");
    const contadorEl = document.getElementById("contador");
    const ultimoRegistroEl = document.getElementById("ultimoRegistro");
    const detalhesEl = document.getElementById("detalhes");
    const atualizacaoEl = document.getElementById("atualizacao");
    const btnSalvar = document.getElementById("btnSalvar");
    const btnSair = document.getElementById("btnSair");
    const tbody = document.querySelector("#ultimosRegistros tbody");
    const headerRight = document.getElementById("headerRight");

    // Dados do operador (do index.html)
    const operadorNome = localStorage.getItem("operador_nome");
    const operadorId = localStorage.getItem("operador_id");

    if (!operadorId) {
      alert("Operador n√£o autenticado. Fa√ßa login.");
      window.location.href = "index.html";
      return;
    }
    operadorNomeEl.textContent = operadorNome;
    headerRight.textContent = "Logado: " + operadorNome;

    // Salvar/recuperar sele√ß√£o local
    function salvarSelecaoLocal(maquinaId, pecaId) {
      localStorage.setItem("sel_maquina_id", maquinaId || "");
      localStorage.setItem("sel_peca_id", pecaId || "");
    }
    function lerSelecaoLocal() {
      return {
        maquina_id: localStorage.getItem("sel_maquina_id") || "",
        peca_id: localStorage.getItem("sel_peca_id") || ""
      };
    }

    // Carrega listas do Supabase
    async function carregarListas() {
      // m√°quinas: id, nome, descricao
      const { data: maquinas, error: errM } = await supabase
        .from("maquinas")
        .select("id,nome,descricao")
        .order("nome", { ascending: true });

      if (errM) {
        console.error("Erro carregando m√°quinas:", errM);
        selectMaquina.innerHTML = '<option value="">Erro ao carregar</option>';
      } else {
        selectMaquina.innerHTML = '<option value="">-- selecione m√°quina --</option>';
        maquinas.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.nome + (m.descricao ? (" ‚Äî " + m.descricao) : "");
          selectMaquina.appendChild(opt);
        });
      }

      // pe√ßas: id, codigo, nome
      const { data: pecas, error: errP } = await supabase
        .from("pecas")
        .select("id,codigo,nome")
        .order("nome", { ascending: true });

      if (errP) {
        console.error("Erro carregando pe√ßas:", errP);
        selectPeca.innerHTML = '<option value="">Erro ao carregar</option>';
      } else {
        selectPeca.innerHTML = '<option value="">-- selecione pe√ßa --</option>';
        pecas.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = (p.codigo ? "["+p.codigo+"] " : "") + p.nome;
          selectPeca.appendChild(opt);
        });
      }

      // aplicar sele√ß√£o salva (se houver)
      const sel = lerSelecaoLocal();
      if (sel.maquina_id) selectMaquina.value = sel.maquina_id;
      if (sel.peca_id) selectPeca.value = sel.peca_id;
    }

    // Atualiza painel (total e √∫ltimos registros) filtrando por operador+m√°quina+peca
    async function atualizarPainel() {
      const maquinaId = selectMaquina.value;
      const pecaId = selectPeca.value;

      if (!maquinaId || !pecaId) {
        contadorEl.textContent = "0";
        ultimoRegistroEl.textContent = "M√°quina ou pe√ßa n√£o selecionada.";
        detalhesEl.textContent = "Selecione m√°quina e pe√ßa para ver a produ√ß√£o.";
        tbody.innerHTML = "";
        atualizacaoEl.textContent = "Aguardando sele√ß√£o";
        return;
      }

      atualizacaoEl.textContent = "Atualizando...";

      try {
        // buscar √∫ltimos registros (maiores data_hora) do operador filtrando por m√°quina e pe√ßa
        const { data: ultimos, error: errLast } = await supabase
          .from("producao")
          .select("id,operador_id,maquina,peca,quantidade,data_hora")
          .eq("operador_id", operadorId)
          .eq("maquina", maquinaId)   // assumimos que Arduino grava 'maquina' como id da m√°quina
          .eq("peca", pecaId)         // e 'peca' como id da pe√ßa
          .order("data_hora", { ascending: false })
          .limit(10);

        if (errLast) throw errLast;

        // Preencher tabela de √∫ltimos registros
        tbody.innerHTML = "";
        if (ultimos && ultimos.length) {
          ultimos.forEach(r => {
            const tr = document.createElement("tr");
            const dt = new Date(r.data_hora).toLocaleString("pt-BR");
            tr.innerHTML = `<td>${dt}</td><td>${mostrarNomeMaquina(r.maquina)}</td><td>${mostrarNomePeca(r.peca)}</td><td>${r.quantidade}</td>`;
            tbody.appendChild(tr);
          });

          const rec = ultimos[0];
          ultimoRegistroEl.textContent = `${new Date(rec.data_hora).toLocaleString("pt-BR")} ‚Äî ${mostrarNomeMaquina(rec.maquina)} / ${mostrarNomePeca(rec.peca)} (qtd ${rec.quantidade})`;
        } else {
          ultimoRegistroEl.textContent = "Nenhum registro encontrado para esta combina√ß√£o.";
        }

        // Somar total (quantidade) para essa combina√ß√£o
        const { data: allQty, error: errQty } = await supabase
          .from("producao")
          .select("quantidade")
          .eq("operador_id", operadorId)
          .eq("maquina", maquinaId)
          .eq("peca", pecaId);

        if (errQty) throw errQty;

        const total = (allQty || []).reduce((s, it) => s + (it.quantidade || 0), 0);
        contadorEl.textContent = total;
        detalhesEl.textContent = `Operador: ${operadorNome} ‚Ä¢ M√°quina: ${mostrarNomeMaquina(maquinaId)} ‚Ä¢ Pe√ßa: ${mostrarNomePeca(pecaId)}`;

        atualizacaoEl.textContent = "Atualizado √†s " + new Date().toLocaleTimeString("pt-BR");
      } catch (err) {
        console.error("Erro ao atualizar painel:", err);
        atualizacaoEl.textContent = "Erro ao buscar dados";
      }
    }

    // Helpers: mostrar nome leg√≠vel da m√°quina/pe√ßa a partir do id selecionado
    function mostrarNomeMaquina(maquinaId) {
      const opt = selectMaquina.querySelector(`option[value="${maquinaId}"]`);
      return opt ? opt.textContent : maquinaId;
    }
    function mostrarNomePeca(pecaId) {
      const opt = selectPeca.querySelector(`option[value="${pecaId}"]`);
      return opt ? opt.textContent : pecaId;
    }

    // Event handlers
    btnSalvar.addEventListener("click", () => {
      const mid = selectMaquina.value;
      const pid = selectPeca.value;
      if (!mid || !pid) { alert("Escolha m√°quina e pe√ßa antes de salvar."); return; }
      salvarSelecaoLocal(mid, pid);
      alert("Sele√ß√£o salva localmente.");
      atualizarPainel();
    });

    btnSair.addEventListener("click", () => {
      localStorage.removeItem("operador_nome");
      localStorage.removeItem("operador_id");
      // manter sele√ß√£o local? removemos tamb√©m se preferir: localStorage.removeItem("sel_maquina_id"); localStorage.removeItem("sel_peca_id");
      window.location.href = "index.html";
    });

    // Atualizar automaticamente a cada 5s
    let intervalo = null;
    function iniciarAutoRefresh() {
      if (intervalo) clearInterval(intervalo);
      intervalo = setInterval(() => { atualizarPainel(); }, 5000);
    }

    // inicializa√ß√£o
    (async function init() {
      await carregarListas();
      // se sele√ß√£o local existir, j√° atualiza o painel
      const sel = lerSelecaoLocal();
      if (sel.maquina_id && sel.peca_id) {
        selectMaquina.value = sel.maquina_id;
        selectPeca.value = sel.peca_id;
      }
      await atualizarPainel();
      iniciarAutoRefresh();
    })();

    // Tamb√©m atualizar quando o usu√°rio muda a sele√ß√£o (aplica imediatamente, sem salvar)
    selectMaquina.addEventListener("change", () => { atualizarPainel(); });
    selectPeca.addEventListener("change", () => { atualizarPainel(); });

    // Polyfill/compat (em alguns ambientes o nome global pode ser supabase ou supabaseJs)
    function safeLog() { /* placeholder */ }

  })();
  </script>
</body>
</html>
