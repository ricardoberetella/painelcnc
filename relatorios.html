<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Relatórios - Produção CNC</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 10px 0;
    }

    .container {
      background-color: rgba(255,255,255,0.08);
      padding: 15px;
      border-radius: 12px;
      width: 95%;
      max-width: 1000px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    h1 { color: #38bdf8; margin-bottom: 10px; }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .filtros select, .filtros input, .filtros button {
      padding: 6px 8px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      color: #0f172a;
    }

    .filtros button { background-color: #38bdf8; color: white; cursor: pointer; }
    .filtros button:hover { background-color: #0284c7; }

    #mensagem { font-size: 14px; color: #fbbf24; margin-bottom: 5px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #fff;
      padding: 6px;
      text-align: center;
    }

    th { background-color: rgba(255,255,255,0.2); }

    button#sair {
      padding: 8px 12px;
      margin-top: 10px;
      background-color: #38bdf8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      align-self: center;
    }
    button#sair:hover { background-color: #0284c7; }

    @media (max-width: 768px) {
      .filtros {
        flex-direction: column;
        align-items: stretch;
      }
      .filtros select, .filtros input, .filtros button {
        width: 100%;
      }
      th, td { font-size: 12px; padding: 4px; }
    }

    @media (max-width: 480px) {
      table { font-size: 10px; }
      th, td { padding: 3px; }
      h1 { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Painel de Relatórios</h1>
    <p id="mensagem"></p>

    <div class="filtros">
      <select id="filtroMaquina"><option value="">Todas as Máquinas</option></select>
      <select id="filtroOperador"><option value="">Todos os Operadores</option></select>
      <select id="filtroPeca"><option value="">Todas as Peças</option></select>
      <input type="date" id="filtroDataInicio" />
      <input type="date" id="filtroDataFim" />
      <button id="btnFiltrar">Filtrar</button>
      <button id="btnResetar">Resetar Filtros</button>
      <button id="btnExportar">Exportar CSV</button>
    </div>

    <table id="tabelaRelatorios">
      <thead>
        <tr>
          <th>Máquina</th>
          <th>Operador</th>
          <th>Peça</th>
          <th>Quantidade</th>
          <th>Data/Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="sair">Sair</button>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wcgrcntyencwkwwnuwyz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjZ3JjbnR5ZW5jd2t3d251d3l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDM1NDksImV4cCI6MjA3ODQ3OTU0OX0.dKUY44Cc_D0I00h0ZbhCVmuIonqMlxcIPBhHUOK1YwM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Verifica se é administrador
    const perfil = localStorage.getItem("operador_perfil");
    if (!perfil || perfil.toLowerCase() !== "administrador") {
      alert("Acesso negado! Apenas administradores podem acessar esta página.");
      window.location.href = "index.html";
    }

    const tabelaBody = document.querySelector("#tabelaRelatorios tbody");
    const mensagemEl = document.getElementById("mensagem");

    const filtroMaquina = document.getElementById("filtroMaquina");
    const filtroOperador = document.getElementById("filtroOperador");
    const filtroPeca = document.getElementById("filtroPeca");
    const filtroDataInicio = document.getElementById("filtroDataInicio");
    const filtroDataFim = document.getElementById("filtroDataFim");
    const btnFiltrar = document.getElementById("btnFiltrar");
    const btnResetar = document.getElementById("btnResetar");
    const btnExportar = document.getElementById("btnExportar");

    let relatorios = [];

    async function carregarFiltros() {
      try {
        const { data: maquinas } = await supabase.from("maquinas").select("id, nome").order("nome");
        maquinas.forEach(m => filtroMaquina.appendChild(new Option(m.nome, m.nome)));

        const { data: pecas } = await supabase.from("pecas").select("id, nome").order("nome");
        pecas.forEach(p => filtroPeca.appendChild(new Option(p.nome, p.nome)));

        const { data: operadores } = await supabase.from("operadores").select("nome").order("nome");
        operadores.forEach(op => filtroOperador.appendChild(new Option(op.nome, op.nome)));
      } catch (err) {
        console.error(err);
        mensagemEl.textContent = "Erro ao carregar filtros.";
      }
    }

    async function carregarRelatorios() {
      try {
        const { data, error } = await supabase.from("producao").select("*").order("data_hora", { ascending: false });
        if (error) throw error;
        relatorios = data;
        mostrarTabela(relatorios);
      } catch (err) {
        console.error(err);
        mensagemEl.textContent = "Erro ao carregar relatórios.";
      }
    }

    function mostrarTabela(dados) {
      tabelaBody.innerHTML = "";
      if (!dados || dados.length === 0) {
        mensagemEl.textContent = "Nenhum registro encontrado.";
        return;
      } else {
        mensagemEl.textContent = "";
      }

      dados.forEach(row => {
        const tr = document.createElement("tr");
        tr.dataset.id = row.id;
        tr.innerHTML = `
          <td>${row.maquina}</td>
          <td>${row.operador}</td>
          <td>${row.peca}</td>
          <td>${row.quantidade}</td>
          <td>${new Date(row.data_hora).toLocaleString("pt-BR")}</td>
        `;
        tabelaBody.appendChild(tr);
      });
    }

    function aplicarFiltros(dados) {
      let filtrados = dados;
      if (filtroMaquina.value) filtrados = filtrados.filter(r => r.maquina === filtroMaquina.value);
      if (filtroOperador.value) filtrados = filtrados.filter(r => r.operador === filtroOperador.value);
      if (filtroPeca.value) filtrados = filtrados.filter(r => r.peca === filtroPeca.value);

      const inicio = filtroDataInicio.value ? new Date(filtroDataInicio.value) : null;
      const fim = filtroDataFim.value ? new Date(filtroDataFim.value) : null;

      if (inicio) filtrados = filtrados.filter(r => new Date(r.data_hora) >= inicio);
      if (fim) filtrados = filtrados.filter(r => new Date(r.data_hora) <= fim);

      return filtrados;
    }

    btnFiltrar.addEventListener("click", () => mostrarTabela(aplicarFiltros(relatorios)));

    btnResetar.addEventListener("click", () => {
      filtroMaquina.value = "";
      filtroOperador.value = "";
      filtroPeca.value = "";
      filtroDataInicio.value = "";
      filtroDataFim.value = "";
      mostrarTabela(relatorios);
    });

    btnExportar.addEventListener("click", () => {
      const rows = [["Máquina","Operador","Peça","Quantidade","Data/Hora"]];
      document.querySelectorAll("#tabelaRelatorios tbody tr").forEach(tr => {
        const row = Array.from(tr.children).map(td => td.textContent);
        rows.push(row);
      });
      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(";")).join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "relatorios_producao.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    document.getElementById("sair").addEventListener("click", () => {
      localStorage.removeItem("operador_nome");
      localStorage.removeItem("operador_perfil");
      window.location.href = "index.html";
    });

    // ATUALIZAÇÃO EM TEMPO REAL (INSERT, UPDATE, DELETE)
    const canal = supabase.channel('realtime_producao')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'producao' }, payload => {
        relatorios.unshift(payload.new);
        mostrarTabela(aplicarFiltros(relatorios));
      })
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'producao' }, payload => {
        const index = relatorios.findIndex(r => r.id === payload.new.id);
        if (index !== -1) relatorios[index] = payload.new;
        mostrarTabela(aplicarFiltros(relatorios));
      })
      .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'producao' }, payload => {
        relatorios = relatorios.filter(r => r.id !== payload.old.id);
        mostrarTabela(aplicarFiltros(relatorios));
      })
      .subscribe();

    carregarFiltros();
    carregarRelatorios();
  </script>
</body>
</html>
